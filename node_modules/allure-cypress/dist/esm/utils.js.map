{"version":3,"file":"utils.js","names":["LabelName","Status","extractMetadataFromString","getMessageAndTraceFromError","getStatusFromError","ALLURE_REPORT_STEP_COMMAND","getAllureTestPlan","uint8ArrayToBase64","data","u8arrayLike","Array","isArray","buffer","btoa","String","fromCharCode","apply","getSuitePath","test","path","currentSuite","parent","title","unshift","shouldCommandBeSkipped","command","_last","last","attributes","args","log","name","toReversed","arr","result","i","length","push","isGlobalHook","hookName","getNamesAndLabels","spec","rawName","cleanTitle","labels","suites","titlePath","slice","fullName","concat","relative","join","applyTestPlan","root","testPlan","suiteQueue","s","shift","indicesToRemove","getIndicesOfDeselectedTests","tests","removeSortedIndices","resolveStatusWithDetails","error","status","statusDetails","PASSED","testReportedKey","Symbol","markTestAsReported","isTestReported","hookTypeRegexp","getHookType","match","exec","includedInTestPlan","allureId","some","_test$id","id","toString","selector","forEach","index","_labels$find","find","_ref","ALLURE_ID","value","indices","splice"],"sources":["../../src/utils.ts"],"sourcesContent":["import { LabelName, Status } from \"allure-js-commons\";\nimport { extractMetadataFromString, getMessageAndTraceFromError, getStatusFromError } from \"allure-js-commons/sdk\";\nimport type { TestPlanV1 } from \"allure-js-commons/sdk\";\nimport { ALLURE_REPORT_STEP_COMMAND } from \"./model.js\";\nimport type { CypressCommand, HookPosition, HookScopeType, HookType } from \"./model.js\";\nimport { getAllureTestPlan } from \"./state.js\";\n\nexport const uint8ArrayToBase64 = (data: unknown) => {\n  // @ts-ignore\n  const u8arrayLike = Array.isArray(data) || data.buffer;\n\n  if (!u8arrayLike) {\n    return data as string;\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n  return btoa(String.fromCharCode.apply(null, data as number[]));\n};\n\nexport const getSuitePath = (test: Mocha.Test): string[] => {\n  const path: string[] = [];\n  let currentSuite: Mocha.Suite | undefined = test.parent;\n\n  while (currentSuite) {\n    if (currentSuite.title) {\n      path.unshift(currentSuite.title);\n    }\n\n    currentSuite = currentSuite.parent;\n  }\n\n  return path;\n};\n\nexport const shouldCommandBeSkipped = (command: CypressCommand) => {\n  if (last(command.attributes.args)?.log === false) {\n    return true;\n  }\n\n  if (command.attributes.name === \"task\" && command.attributes.args[0] === \"reportAllureRuntimeMessages\") {\n    return true;\n  }\n\n  // we don't need to report then commands because it's just a promise handle\n  if (command.attributes.name === \"then\") {\n    return true;\n  }\n\n  // we should skip artificial wrap from allure steps\n  if (command.attributes.name === \"wrap\" && command.attributes.args[0] === ALLURE_REPORT_STEP_COMMAND) {\n    return true;\n  }\n\n  return false;\n};\n\nexport const toReversed = <T = unknown>(arr: T[]): T[] => {\n  const result: T[] = [];\n\n  for (let i = arr.length - 1; i >= 0; i--) {\n    result.push(arr[i]);\n  }\n\n  return result;\n};\n\nexport const isGlobalHook = (hookName: string) => {\n  return /(before|after) all/.test(hookName);\n};\n\nexport const last = <T = unknown>(arr: T[]): T | undefined => {\n  return arr[arr.length - 1];\n};\n\nexport const getNamesAndLabels = (spec: Cypress.Spec, test: Mocha.Test) => {\n  const rawName = test.title;\n  const { cleanTitle: name, labels } = extractMetadataFromString(rawName);\n  const suites = test.titlePath().slice(0, -1);\n  const fullName = `${spec.relative}#${[...suites, name].join(\" \")}`;\n  return { name, labels, fullName };\n};\n\nexport const applyTestPlan = (spec: Cypress.Spec, root: Mocha.Suite) => {\n  const testPlan = getAllureTestPlan();\n  if (testPlan) {\n    const suiteQueue = [];\n    for (let s: Mocha.Suite | undefined = root; s; s = suiteQueue.shift()) {\n      const indicesToRemove = getIndicesOfDeselectedTests(testPlan, spec, s.tests);\n      removeSortedIndices(s.tests, indicesToRemove);\n      suiteQueue.push(...s.suites);\n    }\n  }\n};\n\nexport const resolveStatusWithDetails = (error: Error | undefined) =>\n  error\n    ? {\n        status: getStatusFromError(error),\n        statusDetails: getMessageAndTraceFromError(error),\n      }\n    : { status: Status.PASSED };\n\nconst testReportedKey = Symbol(\"The test was reported to Allure\");\n\nexport const markTestAsReported = (test: Mocha.Test) => {\n  (test as any)[testReportedKey] = true;\n};\n\nexport const isTestReported = (test: Mocha.Test) => (test as any)[testReportedKey] === true;\n\nconst hookTypeRegexp = /^\"(before|after) (all|each)\"/;\n\nexport const getHookType = (name: string): HookType | [] => {\n  const match = hookTypeRegexp.exec(name);\n  if (match) {\n    return [match[1] as HookPosition, match[2] as HookScopeType];\n  }\n  return [];\n};\n\nconst includedInTestPlan = (testPlan: TestPlanV1, fullName: string, allureId: string | undefined): boolean =>\n  testPlan.tests.some((test) => (allureId && test.id?.toString() === allureId) || test.selector === fullName);\n\nconst getIndicesOfDeselectedTests = (testPlan: TestPlanV1, spec: Cypress.Spec, tests: readonly Mocha.Test[]) => {\n  const indicesToRemove: number[] = [];\n  tests.forEach((test, index) => {\n    const { fullName, labels } = getNamesAndLabels(spec, test);\n    const allureId = labels.find(({ name }) => name === LabelName.ALLURE_ID)?.value;\n\n    if (!includedInTestPlan(testPlan, fullName, allureId)) {\n      indicesToRemove.push(index);\n    }\n  });\n  return indicesToRemove;\n};\n\nconst removeSortedIndices = <T>(arr: T[], indices: readonly number[]) => {\n  for (let i = indices.length - 1; i >= 0; i--) {\n    arr.splice(indices[i], 1);\n  }\n};\n"],"mappings":"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","ignoreList":[]}